<!doctype html>
<html lang="so">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Foorno Ubax Supermarket System - v3 (Barcode Integrated)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <style>
    body { background: #f4fbff; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .brand { color:#0d6efd; font-weight:700; }
    .low-badge { background:#ffc107; color:#000; padding:3px 7px; border-radius:6px; font-weight:600; }
    .card { box-shadow: 0 1px 6px rgba(13,110,253,0.06); }
    .small-muted { font-size:0.85rem; color:#6c757d; }
    .table-sm td, .table-sm th { vertical-align: middle; }
    .suggestions { position: absolute; z-index:50; background:#fff; width:100%; border:1px solid #ddd; max-height:240px; overflow:auto; }
    .suggest-item { padding:8px; cursor:pointer; }
    .suggest-item:hover { background:#f1f7ff; }
    .customer-info { background:#fff; border:1px solid #e9ecef; padding:10px; border-radius:6px; margin-top:8px; }
    .muted-small { font-size:0.85rem; color:#6c757d; }
    .btn-sm-compact { padding:.25rem .5rem; font-size:.78rem; }
    .centered { text-align:center; }
    .nav-small { font-size:0.9rem; }
    @media print {
      @page { size: A5; margin: 10mm; }
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: absolute; left: 0; top: 0; width: 100%; display:flex; align-items:center; justify-content:center; }
      #printArea .receipt { width:100%; text-align:center; font-family: Arial, sans-serif; }
    }
    @media (max-width:768px) { .container { padding-left:10px; padding-right:10px; } }
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-white border-bottom">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <span class="navbar-brand brand">Foorno Ubax Supermarket System</span>
      <div id="nav-right" class="nav-small"></div>
    </div>
  </nav>

  <div class="container py-4" id="app">
    <!-- LOGIN -->
    <div id="loginView" class="row justify-content-center">
      <div class="col-md-5">
        <div class="card shadow-sm">
          <div class="card-body">
            <h4 class="mb-3 text-center">Admin Login</h4>
            <form id="loginForm" autocomplete="off">
              <div class="mb-3">
                <label class="form-label">Username</label>
                <input id="loginUser" class="form-control" autocomplete="off" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Password</label>
                <input id="loginPass" type="password" class="form-control" autocomplete="new-password" required>
              </div>
              <button class="btn btn-primary w-100">GALI</button>
            </form>
            <p class="small-muted mt-2">Fadlan geli username & password — password lama soo bandhigayo.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div id="mainView" style="display:none;">
      <div class="row g-3">
        <div class="col-md-3">
          <div class="card p-3">
            <h6>Tirakoob</h6>
            <div class="mt-2">
              <div class="mb-2 small-muted">Items guud</div>
              <h4 id="statItems">0</h4>
            </div>
            <div class="mt-2">
              <div class="mb-2 small-muted">Items ku dhow inay dhamaadaan</div>
              <h4 id="statLow">0</h4>
            </div>
            <div class="mt-2">
              <div class="mb-2 small-muted">Iibka maanta (Paid only)</div>
              <h4 id="statToday">0.00</h4>
            </div>
            <div class="mt-3 d-grid gap-2">
              <button class="btn btn-sm btn-outline-secondary" onclick="go('dashboard')">Dashboard</button>
              <button class="btn btn-sm btn-outline-secondary" onclick="go('items')">Manage Items</button>
              <button class="btn btn-sm btn-success" onclick="go('sales')">Iib Cusub</button>
              <button class="btn btn-sm btn-primary" onclick="go('reports')">Reports</button>
              <button class="btn btn-sm btn-warning" onclick="go('barcode')">Barcode Generator</button>
              <button class="btn btn-sm btn-danger" id="logoutBtnSide" onclick="logout()">Logout</button>
            </div>
          </div>
        </div>

        <div class="col-md-9">
          <!-- Dashboard -->
          <div id="dashboardView">
            <div class="card p-3 mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <h5>Dashboard</h5>
                <div>
                  <span class="me-3">Admin: <b id="adminName">admin</b></span>
                </div>
              </div>
              <p class="small-muted mt-2">Ku soo dhawow Foorno Ubax — halkaan ka maamul items, iibka iyo warbixinnada.</p>
            </div>

            <div class="card p-3">
              <h6>Items Ku Dhaw</h6>
              <div id="lowItemsList"></div>
            </div>
          </div>

          <!-- ITEMS -->
          <div id="itemsView" style="display:none;">
            <div class="card p-3 mb-3 d-flex justify-content-between align-items-center">
              <h5>Maareynta Items</h5>
              <div>
                <button class="btn btn-outline-secondary me-2" onclick="go('dashboard')">Dashboard</button>
                <button class="btn btn-primary" id="showAddItemBtn">Add Item</button>
              </div>
            </div>

            <div class="card p-3 mb-3">
              <form id="addItemForm" class="row g-2">
                <input type="hidden" id="editItemId">
                <div class="col-md-4"><input id="itemName" class="form-control" placeholder="Magaca item" required></div>
                <div class="col-md-2"><input id="itemPrice" class="form-control" placeholder="Qiime" type="number" step="0.01" required></div>
                <div class="col-md-2"><input id="itemQty" class="form-control" placeholder="Tirada" type="number" required></div>
                <div class="col-md-2"><input id="itemLow" class="form-control" placeholder="Threshold" type="number" value="5" required></div>
                <div class="col-md-2"><button class="btn btn-success w-100" id="saveItemBtn">Ku dar / Update</button></div>
              </form>
            </div>

            <div class="card p-3">
              <h6>Liiska Items</h6>
              <input id="searchItem" class="form-control mb-2" placeholder="Raadi item...">
              <div style="max-height:420px; overflow:auto;">
                <table class="table table-sm">
                  <thead><tr><th>Magac</th><th>Qiime</th><th>Tirada</th><th>Threshold</th><th>Action</th></tr></thead>
                  <tbody id="itemsTable"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- SALES -->
          <div id="salesView" style="display:none;">
            <div class="card p-3 mb-3 d-flex justify-content-between">
              <h5>Iib Cusub</h5>
              <div>
                <button class="btn btn-outline-secondary" onclick="go('dashboard')">Dashboard</button>
                <button class="btn btn-outline-secondary" onclick="go('items')">Items</button>
                <button class="btn btn-outline-secondary" onclick="go('reports')">Reports</button>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-md-6 position-relative">
                <div class="card p-3">
                  <h6>Item-yada</h6>
                  <input id="saleSearch" class="form-control mb-2" placeholder="Raadi item...">
                  <div id="saleSuggest" class="suggestions" style="display:none;"></div>
                  <div id="saleItemsList" style="max-height:320px; overflow:auto;"></div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card p-3">
                  <h6>Cart</h6>
                  <div id="cartArea"><p class="text-muted">Cart waa madhan yahay.</p></div>

                  <div class="mt-3 d-flex gap-2 align-items-center">
                    <select id="paymentType" class="form-select w-auto">
                      <option value="Paid">Paid</option>
                      <option value="Credit">Credit</option>
                    </select>
                    <div style="flex:1; position:relative;">
                      <input id="creditName" class="form-control" placeholder="Magaca macaamiisha (credit)" style="display:none;">
                      <div id="creditSuggest" class="suggestions" style="display:none;"></div>
                      <div id="creditInfo" style="display:none;" class="customer-info">
                        <div><strong id="creditInfoName"></strong></div>
                        <div class="muted-small">Balance: <b id="creditInfoBalance">0.00</b> USD</div>
                        <div class="mt-2">
                          <button class="btn btn-sm btn-outline-success" id="payBalanceBtn">Pay Balance</button>
                        </div>
                        <div class="mt-2">
                          <small class="muted-small">Items hore u iibsaday:</small>
                          <ul id="creditHistory" class="mb-0" style="max-height:120px; overflow:auto; padding-left:16px;"></ul>
                        </div>
                      </div>
                    </div>
                    <button id="saveSaleBtn" class="btn btn-success ms-auto">Save Iib</button>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <!-- REPORTS -->
          <div id="reportsView" style="display:none;">
            <div class="card p-3 mb-3 d-flex justify-content-between">
              <h5>Warbixinno</h5>
              <div>
                <button class="btn btn-outline-secondary" onclick="go('dashboard')">Dashboard</button>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <div class="card p-3 mb-3">
                  <h6>Iibka Maanta & Guud</h6>
                  <h3 id="reportTodayTotal">0.00</h3>
                  <div class="mt-3">
                    <h6>Credit Customers</h6>
                    <ul id="reportCredits" class="list-group"></ul>
                  </div>
                </div>

                <div class="card p-3">
                  <h6>Return (Celinta)</h6>
                  <p class="small-muted">Geli Order ID si aad u celiso (max 24 saac gudahood)</p>
                  <div class="d-flex gap-2">
                    <input id="returnId" class="form-control" placeholder="Order ID (e.g. INV-4821 )">
                    <button class="btn btn-warning" id="doReturnBtn">Process Return</button>
                  </div>
                  <div id="returnList" class="mt-3"></div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card p-3 mb-3">
                  <h6>Items ku dhow inay dhamaadaan</h6>
                  <ul id="reportLow" class="list-group"></ul>
                </div>

                <div class="card p-3">
                  <h6>Iibyo & Taariikh</h6>
                  <div style="max-height:240px; overflow:auto;">
                    <table class="table table-sm">
                      <thead><tr><th>ID</th><th>Date</th><th>Total</th><th>Type</th></tr></thead>
                      <tbody id="salesTable"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- BARCODE GENERATOR VIEW -->
          <div id="barcodeView" style="display:none;">
            <div class="card p-3 mb-3 d-flex justify-content-between align-items-center">
              <h5>Barcode Generator</h5>
              <div>
                <button class="btn btn-outline-secondary me-2" onclick="go('items')">Items</button>
                <button class="btn btn-outline-secondary" onclick="go('sales')">Sales</button>
              </div>
            </div>

            <div class="card p-3">
              <h6>Daabac Barcode</h6>
              <div id="barcodeItemsList" style="max-height:420px; overflow:auto;"></div>
            </div>
          </div>

        </div> <!-- /col-md-9 -->
      </div> <!-- /row -->
    </div> <!-- /mainView -->
  </div> <!-- /container -->

  <!-- hidden print area -->
  <div id="printArea" style="display:none;">
    <div class="receipt p-3">
      <div style="font-size:18px; font-weight:700;">Foorno Ubax Supermarket System</div>
      <div id="printContent" style="margin-top:10px;"></div>
      <div style="margin-top:10px; font-size:12px;" id="printFooter"></div>
    </div>
  </div>

  <!-- hidden barcode scan input -->
  <input id="barcodeScanInput" type="text" style="position:absolute; top:-120px; left:-120px; opacity:0;">

<script>
/* ===========================
   Storage keys & admin
   =========================== */
const KEY_ITEMS = 'foorno_ubax_items_v3';
const KEY_SALES = 'foorno_ubax_sales_v3';
const KEY_CUSTOMERS = 'foorno_ubax_customers_v3';
const KEY_RETURNS = 'foorno_ubax_returns_v3';
const ADMIN_USER = 'admin';
const ADMIN_PASS = '12345';

function load(key){ try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch(e){ return []; } }
function save(key,data){ localStorage.setItem(key, JSON.stringify(data)); }
function uid(p='id'){ return p + '_' + Date.now() + '_' + Math.floor(Math.random()*9000+1000); }

let items = load(KEY_ITEMS);
let sales = load(KEY_SALES);
let customers = load(KEY_CUSTOMERS);
let returns = load(KEY_RETURNS);

/* seed items if empty */
if (!items || items.length === 0) {
  items = [
    { id: uid('it'), name: 'Rice 5kg', price: 10.00, quantity: 10, low:5 },
    { id: uid('it'), name: 'Sugar 2kg', price: 3.50, quantity: 8, low:5 },
    { id: uid('it'), name: 'Bread', price: 0.50, quantity: 20, low:5 }
  ];
  save(KEY_ITEMS, items);
}

/* UI refs */
const loginForm = document.getElementById('loginForm');
const loginView = document.getElementById('loginView');
const mainView = document.getElementById('mainView');
const navRight = document.getElementById('nav-right');

/* show main */
function showMain(){
  loginView.style.display = 'none';
  mainView.style.display = '';
  navRight.innerHTML = `<div class="d-flex align-items-center"><small class="me-3">Admin: <b>${ADMIN_USER}</b></small></div>`;
  updateStats();
  renderLowList();
  showAlertIfLow();
  go('dashboard');
}

/* logout */
function logout(){
  sessionStorage.removeItem('foorno_ubax_logged');
  location.reload();
}
document.getElementById('logoutBtnSide').addEventListener('click', logout);

/* login submit */
loginForm.addEventListener('submit', function(e){
  e.preventDefault();
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  if (u === ADMIN_USER && p === ADMIN_PASS) {
    sessionStorage.setItem('foorno_ubax_logged','1');
    showMain();
    Swal.fire('Sax','Waan ku soo dhaweynayaa','success');
  } else {
    Swal.fire('Khalad','Username ama password khalad ah','error');
  }
});
if (sessionStorage.getItem('foorno_ubax_logged')) showMain();

/* NAV */
function hideAllViews(){
  document.getElementById('dashboardView').style.display = 'none';
  document.getElementById('itemsView').style.display = 'none';
  document.getElementById('salesView').style.display = 'none';
  document.getElementById('reportsView').style.display = 'none';
  document.getElementById('barcodeView').style.display = 'none';
}
function go(page){
  hideAllViews();
  if (page==='dashboard') document.getElementById('dashboardView').style.display = '';
  if (page==='items') { document.getElementById('itemsView').style.display = ''; renderItemsTable(); }
  if (page==='sales') { document.getElementById('salesView').style.display = ''; renderSaleItemsList(); renderCart(); focusScanInput(); }
  if (page==='reports') { document.getElementById('reportsView').style.display = ''; renderReports(); }
  if (page==='barcode') { document.getElementById('barcodeView').style.display = ''; renderBarcodeItems(); }
}

/* ITEMS CRUD */
const itemsTable = document.getElementById('itemsTable');
const addItemForm = document.getElementById('addItemForm');

function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

function renderItemsTable(filter=''){
  items = load(KEY_ITEMS);
  itemsTable.innerHTML = '';
  const q = (filter||'').trim().toLowerCase();
  items.forEach(it=>{
    if (q && !it.name.toLowerCase().includes(q)) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(it.name)}</td>
      <td>${parseFloat(it.price).toFixed(2)}</td>
      <td>${parseInt(it.quantity)} ${it.quantity <= it.low ? `<span class="ms-2 low-badge">Low</span>` : ''}</td>
      <td>${parseInt(it.low)}</td>
      <td>
        <button class="btn btn-sm btn-secondary me-1" data-act="edit" data-id="${it.id}">Edit</button>
        <button class="btn btn-sm btn-outline-primary me-1" data-act="print" data-id="${it.id}">Print Barcode</button>
        <button class="btn btn-sm btn-danger" data-act="del" data-id="${it.id}">Delete</button>
      </td>`;
    itemsTable.appendChild(tr);
  });
}
itemsTable.addEventListener('click', function(e){
  const btn = e.target.closest('button');
  if (!btn) return;
  const act = btn.dataset.act, id = btn.dataset.id;
  if (act === 'edit') {
    const it = items.find(x=>x.id===id);
    if (!it) return;
    document.getElementById('editItemId').value = it.id;
    document.getElementById('itemName').value = it.name;
    document.getElementById('itemPrice').value = parseFloat(it.price);
    document.getElementById('itemQty').value = parseInt(it.quantity);
    document.getElementById('itemLow').value = parseInt(it.low);
    window.scrollTo({top:0, behavior:'smooth'});
  } else if (act === 'del') {
    Swal.fire({ title:'Ma hubtaa?', text:'Miyaad rabtaa inaad tirtirto itemkan?', icon:'warning', showCancelButton:true })
    .then(res=>{ if (res.isConfirmed){ items = items.filter(x=>x.id!==id); save(KEY_ITEMS, items); renderItemsTable(document.getElementById('searchItem').value||''); updateStats(); Swal.fire('La tirtiray','Item waa la tirtiray','success'); }});
  } else if (act === 'print') {
    const it = items.find(x=>x.id===id);
    if (!it) return;
    generateAndPrintBarcode(it);
  }
});
addItemForm.addEventListener('submit', function(e){
  e.preventDefault();
  const id = document.getElementById('editItemId').value;
  const name = document.getElementById('itemName').value.trim();
  const price = parseFloat(document.getElementById('itemPrice').value) || 0;
  const qty = parseInt(document.getElementById('itemQty').value) || 0;
  const low = parseInt(document.getElementById('itemLow').value) || 5;
  if (!name) return Swal.fire('Khalad','Fadlan geli magaca item','error');
  items = load(KEY_ITEMS);
  if (id) {
    items = items.map(it => it.id===id ? {...it, name, price, quantity: qty, low} : it);
    Swal.fire('La cusbooneysiiyey','Item waa la cusbooneysiiyey','success');
  } else {
    items.push({ id: uid('it'), name, price, quantity: qty, low });
    Swal.fire('La daray','Item cusub waa la daray','success');
  }
  save(KEY_ITEMS, items);
  document.getElementById('editItemId').value = '';
  addItemForm.reset();
  renderItemsTable();
  updateStats();
});
document.getElementById('searchItem').addEventListener('input', function(){ renderItemsTable(this.value); });
document.getElementById('showAddItemBtn').addEventListener('click', function(){ document.getElementById('editItemId').value=''; addItemForm.reset(); window.scrollTo({top:0, behavior:'smooth'}); });

/* SALES + CART + SUGGEST */
let cart = [];
const saleSearch = document.getElementById('saleSearch');
const saleSuggest = document.getElementById('saleSuggest');

function renderSaleItemsList(){
  items = load(KEY_ITEMS);
  const container = document.getElementById('saleItemsList');
  container.innerHTML = '';
  items.forEach(it=>{
    const div = document.createElement('div');
    div.className = 'd-flex align-items-center justify-content-between p-2 border-bottom';
    div.innerHTML = `<div><strong>${escapeHtml(it.name)}</strong><br><small>${parseFloat(it.price).toFixed(2)} USD — Qty: ${it.quantity}</small> ${it.quantity <= it.low ? ' <span class="low-badge ms-2">Low</span>' : ''}</div>
      <div style="min-width:160px">
        <input type="number" value="1" min="1" max="${it.quantity}" class="form-control form-control-sm mb-1 addQty" data-id="${it.id}" style="width:80px; display:inline-block; margin-right:6px;">
        <button class="btn btn-sm btn-primary w-100 addToCart" data-id="${it.id}">Add</button>
      </div>`;
    container.appendChild(div);
  });
  saleSearch.value = '';
  hideSuggest();
}
document.getElementById('saleItemsList').addEventListener('click', function(e){
  const btn = e.target.closest('button.addToCart');
  if (!btn) return;
  const id = btn.dataset.id;
  const qtyInput = btn.parentElement.querySelector('.addQty');
  let q = parseInt(qtyInput.value) || 1;
  const it = items.find(x=>x.id===id);
  if (!it) return Swal.fire('Error','Item lama helin','error');
  if (q > it.quantity) return Swal.fire('Error',`Kaliya ${it.quantity} ayaa la heli karaa`,`error`);
  addToCart(id,q);
  // NOTE: barcode print is NOT triggered on Add anymore (user requested)
});
saleSearch.addEventListener('input', function(){
  const q = this.value.trim().toLowerCase();
  if (!q) {
